name: Multi Repo Deployment Monitor

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: true
        default: thandera
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod
          - prod2

permissions:
  contents: read
  actions: write

jobs:
  deploy-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Set repository list
        run: |
          echo "REPOS=Nikhil,sumedh,vaibhav,ajay" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Trigger deployments
        env:
          TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          BRANCH: ${{ inputs.branch }}
          ENV: ${{ inputs.environment }}
        run: |
          for repo in $(echo $REPOS | tr ',' ' '); do
            echo "Triggering deployment for $repo"

            curl -s -o /dev/null -w "%{http_code}\n" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $TOKEN" \
              https://api.github.com/repos/nikhil19980716-web/$repo/actions/workflows/newblank.yml/dispatches \
              -d "{
                \"ref\": \"$BRANCH\",
                \"inputs\": { \"environment\": \"$ENV\" }
              }"
          done

      - name: Monitor deployments and collect status
        env:
          TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: |
          echo "| Repository | Status |" >> summary.md
          echo "|------------|--------|" >> summary.md

          FAILED=0

          for repo in $(echo $REPOS | tr ',' ' '); do
            echo "Monitoring $repo..."

            sleep 5

            RUN_ID=$(curl -s \
              -H "Authorization: Bearer $TOKEN" \
              https://api.github.com/repos/nikhil19980716-web/$repo/actions/workflows/newblank.yml/runs \
              | jq -r '.workflow_runs[0].id')

            while true; do
              RUN_DATA=$(curl -s \
                -H "Authorization: Bearer $TOKEN" \
                https://api.github.com/repos/nikhil19980716-web/$repo/actions/runs/$RUN_ID)

              STATUS=$(echo "$RUN_DATA" | jq -r '.status')
              RESULT=$(echo "$RUN_DATA" | jq -r '.conclusion')

              if [[ "$STATUS" == "completed" ]]; then
                break
              fi

              sleep 10
            done

            if [[ "$RESULT" == "success" ]]; then
              echo "| $repo | ✅ Success |" >> summary.md
            else
              echo "| $repo | ❌ Failed |" >> summary.md
              FAILED=1
            fi
          done

          cat summary.md >> $GITHUB_STEP_SUMMARY

          if [[ "$FAILED" == "1" ]]; then
            exit 1
          fi
