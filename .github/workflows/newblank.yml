name: Deploy Multiple Repos (With Status)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to deploy
        required: true
        default: thandera
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod
          - prod2

permissions:
  contents: read
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Define repositories
        run: echo "REPOS=nikhil,sumedh,vaibhav,ajay" >> $GITHUB_ENV

      - name: Trigger and monitor deployments
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          OWNER: nikhil19980716-web
          BRANCH: ${{ github.event.inputs.branch }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |
          echo "| Repo | Run ID | Status |" >> summary.md
          echo "|------|--------|--------|" >> summary.md

          for repo in $(echo $REPOS | tr ',' ' '); do
            echo "ðŸš€ Triggering $repo"

            # Get workflow ID
            WF_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$OWNER/$repo/actions/workflows \
              | jq -r '.workflows[] | select(.path==".github/workflows/deploy.yml") | .id')

            if [ -z "$WF_ID" ]; then
              echo "| $repo | - | âŒ Workflow not found |" >> summary.md
              continue
            fi

            # Trigger workflow
            TRIGGER_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$OWNER/$repo/actions/workflows/$WF_ID/dispatches \
              -d "{
                \"ref\": \"$BRANCH\",
                \"inputs\": { \"environment\": \"$ENVIRONMENT\" }
              }")

            if [ "$TRIGGER_CODE" != "204" ]; then
              echo "| $repo | - | âŒ Trigger failed ($TRIGGER_CODE) |" >> summary.md
              continue
            fi

            echo "â³ Waiting for run to start..."

            sleep 5

            RUN_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$OWNER/$repo/actions/workflows/$WF_ID/runs?branch=$BRANCH \
              | jq -r '.workflow_runs[0].id')

            if [ -z "$RUN_ID" ]; then
              echo "| $repo | - | âŒ Run not found |" >> summary.md
              continue
            fi

            # Poll status
            while true; do
              STATUS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                https://api.github.com/repos/$OWNER/$repo/actions/runs/$RUN_ID \
                | jq -r '.status')

              CONCLUSION=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                https://api.github.com/repos/$OWNER/$repo/actions/runs/$RUN_ID \
                | jq -r '.conclusion')

              if [ "$STATUS" = "complete]()
